version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
env:
  variables:
    docker_server: nrt.ocir.io
  vaultVariables:
    repository: ocid1.vaultsecret.oc1.ap-tokyo-1.amaaaaaassl65iqa3a6633az4kcvuhacslbefj57tncpysuy5y7ozldwkhyq
  exportedVariables:
    - tag

steps:
  - type: Command
    name: "Build Docker Image"
    command: |
      tag=${OCI_TRIGGER_COMMIT_HASH}
      docker build -t helidon-k8s-app .
    onFailure:
      - type: Command
        command: |
          echo "Failure successfully handled"
        timeoutInSeconds: 60
  - type: Command
    name: "Update Kubernetes Manifest"
    command: |
      echo "docker_server:" ${docker_server}
      echo "repository:" ${repository}
      echo "tag:" ${tag}
      sed -i -e s/'${docker_server}'/${docker_server}/g -e s/'${repository}'/${repository}/g -e s/'${tag}'/${tag}/g ./app.yaml
    onFailure:
      - type: Command
        command: |
          echo "Failure successfully handled"
        timeoutInSeconds: 60

outputArtifacts:
  - name: helidon-k8s-app
    type: DOCKER_IMAGE
    location: helidon-k8s-app
  - name: helidon-k8s-app-manifest
    type: BINARY
    location: app.yaml